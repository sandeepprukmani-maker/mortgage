# Azure Pipeline - Valargen CI/CD
# Triggers on commits to master branch
# Auto-deploys to staging, manual approval for production

trigger:
  branches:
    include:
      - master
  paths:
    exclude:
      - README.md
      - docs/**
      - '*.md'

pr:
  branches:
    include:
      - master

pool:
  vmImage: 'ubuntu-latest'  # Microsoft-hosted agent with Docker

variables:
  - group: valargen-secrets  # Create this variable group in Azure DevOps
  - name: DOCKER_BUILDKIT
    value: 1
  - name: COMPOSE_DOCKER_CLI_BUILD
    value: 1

stages:
  # ==========================================
  # Stage 1: Build & Test
  # ==========================================
  - stage: BuildAndTest
    displayName: 'Build & Test'
    jobs:
      - job: Test
        displayName: 'Run Tests'
        steps:
          - checkout: self
            fetchDepth: 1

          - task: Docker@2
            displayName: 'Build Server Image'
            inputs:
              command: build
              dockerfile: app/server/Dockerfile
              buildContext: app/server
              tags: |
                valargen-server:$(Build.BuildId)
                valargen-server:latest

          - task: Docker@2
            displayName: 'Build Client Image'
            inputs:
              command: build
              dockerfile: app/client/Dockerfile
              buildContext: app/client
              tags: |
                valargen-client:$(Build.BuildId)
                valargen-client:latest

          - script: |
              echo "Running server tests..."
              docker run --rm valargen-server:$(Build.BuildId) /app/.venv/bin/pytest -v --tb=short
            displayName: 'Run Server Tests'
            continueOnError: false

          - script: |
              echo "Running linting..."
              docker run --rm valargen-server:$(Build.BuildId) /app/.venv/bin/ruff check . || true
            displayName: 'Run Linter'
            continueOnError: true

          - task: PublishTestResults@2
            displayName: 'Publish Test Results'
            condition: succeededOrFailed()
            inputs:
              testResultsFiles: '**/test-results.xml'
              failTaskOnFailedTests: true

  # ==========================================
  # Stage 2: Deploy to Staging
  # ==========================================
  - stage: DeployStaging
    displayName: 'Deploy to Staging'
    dependsOn: BuildAndTest
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))
    jobs:
      - deployment: DeployToStaging
        displayName: 'Deploy to Staging VM'
        environment: 'staging'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - task: AzureCLI@2
                  displayName: 'Deploy to Staging VM'
                  inputs:
                    azureSubscription: 'valargen-azure-connection'  # Service connection name
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      echo "Deploying to Staging VM..."

                      # VM details
                      RESOURCE_GROUP="valargen-staging-rg"
                      VM_NAME="valargen-staging-vm"

                      # Deploy script
                      az vm run-command invoke \
                        --resource-group $RESOURCE_GROUP \
                        --name $VM_NAME \
                        --command-id RunShellScript \
                        --scripts @scripts/azure-vm-deploy.sh \
                        --parameters "GIT_BRANCH=master" "ENVIRONMENT=staging"

                - script: |
                    echo "Waiting for deployment to complete..."
                    sleep 30

                    echo "Verifying staging deployment..."
                    curl -f https://app.staging.valargen.com/health || exit 1
                    echo "âœ“ Staging deployment verified"
                  displayName: 'Verify Staging Deployment'

                - script: |
                    echo "ðŸŽ‰ Deployment to staging complete!"
                    echo "URL: https://app.staging.valargen.com"
                    echo "API Docs: https://app.staging.valargen.com/docs"
                  displayName: 'Deployment Summary'

  # ==========================================
  # Stage 3: Deploy to Production (Manual)
  # ==========================================
  - stage: DeployProduction
    displayName: 'Deploy to Production'
    dependsOn: DeployStaging
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))
    jobs:
      - deployment: DeployToProduction
        displayName: 'Deploy to Production VM'
        environment: 'production'  # Requires manual approval
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - task: AzureCLI@2
                  displayName: 'Deploy to Production VM'
                  inputs:
                    azureSubscription: 'valargen-azure-connection'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      echo "Deploying to Production VM..."

                      # VM details
                      RESOURCE_GROUP="valargen-production-rg"
                      VM_NAME="valargen-production-vm"

                      # Deploy script
                      az vm run-command invoke \
                        --resource-group $RESOURCE_GROUP \
                        --name $VM_NAME \
                        --command-id RunShellScript \
                        --scripts @scripts/azure-vm-deploy.sh \
                        --parameters "GIT_BRANCH=master" "ENVIRONMENT=production"

                - script: |
                    echo "Waiting for deployment to complete..."
                    sleep 30

                    echo "Verifying production deployment..."
                    curl -f https://app.valargen.com/health || exit 1
                    echo "âœ“ Production deployment verified"
                  displayName: 'Verify Production Deployment'

                - script: |
                    echo "ðŸŽ‰ Deployment to production complete!"
                    echo "URL: https://app.valargen.com"
                    echo "API Docs: https://app.valargen.com/docs"
                  displayName: 'Deployment Summary'
