# Docker Compose - Staging environment for Azure VM (D2s v3: 2 vCPU, 8GB RAM)
# Run with: docker compose --env-file .env.staging -f docker-compose.yml -f docker-compose.staging.yml up -d

services:
  # Caddy reverse proxy with automatic SSL
  caddy:
    image: caddy:2-alpine
    container_name: valargen-caddy
    restart: unless-stopped
    ports:
      - "0.0.0.0:80:80"
      - "0.0.0.0:443:443"
    volumes:
      - ./infra/staging/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy-data:/data
      - caddy-config:/config
    networks:
      - valargen-network
    depends_on:
      client:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 64M

  server:
    env_file:
      - ./app/server/.env
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
    environment:
      - DEBUG=0
      - LOG_LEVEL=info
      - ENVIRONMENT=staging
      # Override in .env.staging
      - DATABASE_URL=${DATABASE_URL:-postgresql://valargen:valargen@pgbouncer:6432/valargen}
      - REDIS_URL=${REDIS_URL:-redis://redis:6379}
      - STORAGE_CONNECTION_STRING=${STORAGE_CONNECTION_STRING}
      - CORS_ORIGINS=${CORS_ORIGINS:-https://app.staging.valargen.com}
      # Google OAuth - must use staging URLs
      - GOOGLE_REDIRECT_URI=https://${DOMAIN:-app.staging.valargen.com}/api/auth/google/callback
      - FRONTEND_URL=https://${DOMAIN:-app.staging.valargen.com}
      # Security settings for HTTPS
      - COOKIE_SECURE=1
      - COOKIE_SAMESITE=lax

  client:
    # Client uses expose:80 (internal only), Caddy handles external traffic
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: '0.25'
        reservations:
          memory: 64M

  pgbouncer:
    environment:
      - DATABASES_USER=${POSTGRES_USER:-valargen}
      - DATABASES_PASSWORD=${POSTGRES_PASSWORD:-valargen}
      - DATABASES_DBNAME=${POSTGRES_DB:-valargen}
      - MAX_CLIENT_CONN=50
      - DEFAULT_POOL_SIZE=10
      - MIN_POOL_SIZE=2
      - RESERVE_POOL_SIZE=2
    deploy:
      resources:
        limits:
          memory: 64M
        reservations:
          memory: 32M

  postgres:
    ports:
      - "10.0.0.4:5432:5432"  # Expose only on internal IP (Twingate access only)
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-valargen}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-valargen}
      - POSTGRES_DB=${POSTGRES_DB:-valargen}
    command:
      - postgres
      - -c
      - shared_buffers=256MB
      - -c
      - work_mem=4MB
      - -c
      - maintenance_work_mem=64MB
      - -c
      - effective_cache_size=512MB
      - -c
      - max_connections=50
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '0.5'
        reservations:
          memory: 512M

  redis:
    command: redis-server --appendonly yes --maxmemory 128mb --maxmemory-policy allkeys-lru
    deploy:
      resources:
        limits:
          memory: 192M
        reservations:
          memory: 128M

  azurite:
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  # Twingate connector for zero trust access and static IP
  twingate-connector:
    image: twingate/connector:1
    container_name: valargen-twingate-connector
    restart: unless-stopped
    network_mode: host
    environment:
      - TWINGATE_REFRESH_TOKEN=${TWINGATE_REFRESH_TOKEN}
      - TWINGATE_ACCESS_TOKEN=${TWINGATE_ACCESS_TOKEN}
      - TWINGATE_NETWORK=${TWINGATE_NETWORK}
      - TWINGATE_LABEL=${TWINGATE_LABEL:-valargen-staging}
      - TWINGATE_LOG_LEVEL=${TWINGATE_LOG_LEVEL:-3}
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: '0.25'
        reservations:
          memory: 64M

volumes:
  caddy-data:
  caddy-config:

networks:
  valargen-network:
    driver: bridge
