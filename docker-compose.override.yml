# Local development overrides - connects server directly to postgres
# This avoids pgbouncer DNS issues in local Docker environment

services:
  server:
    image: valargen-local-server:latest
    build: null
    command: /app/.venv/bin/uvicorn main:app --host 0.0.0.0 --port 8000 --workers 2
    # Expose port 8000 to host for local development
    ports:
      - "8000:8000"
    volumes:
      - ./app/server/.env.local:/app/.env:ro
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      # Override to connect directly to postgres instead of pgbouncer (avoids DNS issues)
      - DATABASE_URL=postgresql://valargen:valargen@postgres:5432/valargen
      # SOCKS proxy for all outbound HTTP (Google OAuth, etc.)
      - ALL_PROXY=socks5://host.docker.internal:1080
    env_file:
      - ./app/server/.env.local

  client:
    build:
      context: ./app/client
      dockerfile: Dockerfile
      target: development
    ports:
      - "5173:5173"
    volumes:
      - ./app/client:/app
      - /app/node_modules
    depends_on:
      - server
    command: sh -c "if [ ! -d node_modules ] || [ package.json -nt node_modules ]; then echo 'Installing dependencies...' && npm install; fi && npm run dev"

  # Also expose redis and postgres for direct access in local dev
  redis:
    ports:
      - "6379:6379"

  postgres:
    ports:
      - "5432:5432"
